name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - 'setup.py'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      version-changed: ${{ steps.check-tag.outputs.changed }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from setup.py
      id: get-version
      run: |
        VERSION=$(python -c "import re; content=open('setup.py').read(); print(re.search(r'version=\"([^\"]+)\"', content).group(1))")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version found: $VERSION"

    - name: Check if tag exists
      id: check-tag
      run: |
        if git rev-parse "v${{ steps.get-version.outputs.version }}" >/dev/null 2>&1; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.get-version.outputs.version }} already exists"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Tag v${{ steps.get-version.outputs.version }} does not exist"
        fi

  create-release:
    needs: check-version
    if: needs.check-version.outputs.version-changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Create and push tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ needs.check-version.outputs.version }}" -m "Release v${{ needs.check-version.outputs.version }}"
        git push origin "v${{ needs.check-version.outputs.version }}"

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$PREV_TAG" ]; then
          # First release, get all commits
          CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
        else
          # Get commits since last tag
          CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        fi

        # Save to file for multiline output
        echo "$CHANGELOG" > /tmp/changelog.txt
        echo "Generated changelog from ${PREV_TAG:-initial commit}"

    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "v${{ needs.check-version.outputs.version }}" \
          --title "Release v${{ needs.check-version.outputs.version }}" \
          --notes-file /tmp/changelog.txt
